@if (gameDetails$ | async; as game) {
  <h3>Spielübersicht</h3>
  <div class="game-info-container">
    <div class="game-info-item">
      <mat-icon>today</mat-icon>
      {{game.datetime | date:'dd.MM.yyyy'}}
    </div>

    <div class="game-info-item">
      <mat-icon>place</mat-icon>
      @if (game.place.type === PlaceTypeEnum.Home) {
        bei {{game.place.locationLabel}}
      } @else if (game.place.type === PlaceTypeEnum.Away) {
        {{game.place.type | placeTypeToLabel}} ({{game.place.locationLabel}})
      } @else {
        {{game.place.type | placeTypeToLabel}}
      }
    </div>

    @if (game.excludeFromStatistics) {
      <div class="game-info-item">
        <mat-icon>visibility_off</mat-icon>
        ohne Wertung
      </div>
    }

    <button mat-stroked-button (click)="openGameDetailsDialog()">
      <mat-icon>edit</mat-icon>
      bearbeiten
    </button>
  </div>

  <mat-stepper orientation="vertical" #stepper>
    <ng-template matStepperIcon="edit" let-index="index">
      <span *ngIf="index > 0">{{index}}</span>
      <mat-icon *ngIf="index === 0">gavel</mat-icon>
    </ng-template>
    <ng-template matStepperIcon="number" let-index="index">
      <span *ngIf="index > 0">{{index}}</span>
      <mat-icon *ngIf="index === 0">gavel</mat-icon>
    </ng-template>

    <mat-step>
      <ng-template matStepLabel>
        <div>
          Feststellungen
        </div>
        <div class="penalty-sum-container">
          @if (game.penalties && game.penalties.length) {
            @for (penalty of game.penalties; track penalty.unit) {
              <hop-penalty-with-unit [penalty]="penalty.sum" [unit]="penalty.unit"></hop-penalty-with-unit>
            }
          } @else {
            <span>-</span>
          }
        </div>
      </ng-template>
      <ng-template matStepContent>
        <hop-event-list
          [context]="Context.Game"
          [players]="(playersForGameEvents$ | async) || []"
          [events]="game.events"
          [disabled]="game.completed"
          (onEventAdd)="handleGameEventAdd($event)"
          (onEventRemove)="handleGameEventRemove($event)"
        ></hop-event-list>
      </ng-template>
    </mat-step>

    @for (round of rounds$ | async; track round.id) {
      <mat-step completed="true">
        <ng-template matStepLabel>
          <div class="round-marker-list">
            @if (round.hasFinal) {
              <mat-icon>sports_score</mat-icon>
            }
            @if (round.schockAusCount > 0) {
              <mat-icon aria-hidden="false" style="margin: 10px 0;" [matBadge]="round.schockAusCount" matBadgeSize="large" [matBadgeHidden]="round.schockAusCount === 1" svgIcon="schock_aus"></mat-icon>
            }
          </div>
          <div class="penalty-sum-container">
            @if (round.penalties && round.penalties.length) {
              @for (penalty of round.penalties; track penalty.unit) {
                <hop-penalty-with-unit [penalty]="penalty.sum" [unit]="penalty.unit"></hop-penalty-with-unit>
              }
            } @else {
              <span>-</span>
            }
          </div>
        </ng-template>
        <ng-template matStepContent>
          <hop-round
            [round]="round"
            [players]="(players$ | async) || []"
            [activePlayers]="(activePlayers$ | async) || []"
            [disabled]="game.completed"
            (onEventAdd)="handleRoundEventAdd($event)"
            (onEventRemove)="handleRoundEventRemove($event)"
            (onRoundRemove)="handleRoundRemove($event)"
            (onFinalistsChange)="handleFinalistsChange($event)"
            (onAttendanceChange)="handleAttendanceChange($event)"
          ></hop-round>
        </ng-template>
      </mat-step>
    }
  </mat-stepper>

  @if (!game.completed) {
    <button mat-flat-button (click)="startNewRound()">
      <mat-icon>add</mat-icon>
      Neue Runde
    </button>

    <div>
      <button mat-flat-button (click)="setGameCompleted($event)">
        <mat-icon>check</mat-icon>
        Spiel abschließen
      </button>
    </div>
  }
}
